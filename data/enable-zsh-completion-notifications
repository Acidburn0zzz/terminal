# This file should be sourced  from /etc/zshrc or $ZDOTDIR/.zshrc in order to
# enable process completion notifications in Pantheon Terminal. 
# Like this:
#builtin . /usr/share/pantheon-terminal/enable-zsh-completion-notifications || builtin true

# If you come up with a way to inject this without modifying those files,
# please let me know at <sergey@elementaryos.org>

if [[ -n "$PANTHEON_TERMINAL_ID" ]] \
&& builtin hash dbus-send 2> /dev/null \
&& [[ -z $(whence pantheon_terminal_command_competion_callback) ]]
then
    pantheon_terminal_command_competion_callback() {
        dbus-send \
            --type=method_call \
            --session \
            --dest=net.launchpad.pantheon-terminal \
            /net/launchpad/pantheon_terminal \
            org.pantheon.terminal.ProcessFinished \
            string:$PANTHEON_TERMINAL_ID \
            string:"$(fc -ln -1)"
    }
    precmd_functions=(pantheon_terminal_command_competion_callback)
fi

# Work around Pantheon Terminal's workarounds for how constrained BASH is.
if [[ -n "$PANTHEON_TERMINAL_ID" ]] \
&& builtin hash dbus-send 2> /dev/null
then
    pantheon-terminal-process-completion-callback
fi
# Yes, really, and that's terrifying.
# BASH has no usable post-execution hook, but it has a convenient pre-promt hook
# available from an environment variable, so we use that.
# But that generates an extra notification on startup which has to be suppressed.
# And so far the only reliable way to do that we came up with
# was ignoring the first callback in each tab. 
# Just like that.
# I've tried some clever focus-based trickery, but it was unreliable:
# https://bugs.launchpad.net/pantheon-terminal/+bug/1356937
# Please let us know if you come up with anything better or can patch BASH.
